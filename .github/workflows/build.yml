name: Build ImmortalWrt HC5861B Hysteria2

on:
  workflow_dispatch:
    inputs:
      RELEASE:
        description: '发布到 Release'
        type: boolean
        default: true

env:
  # ★ 改用 ImmortalWrt（有 HC5861B 支持）
  REPO_URL: https://github.com/immortalwrt/immortalwrt.git
  REPO_BRANCH: openwrt-23.05
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Install dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache clang cmake cpio curl \
          device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
          g++-multilib git gnutls-dev gperf haveged help2man intltool jq \
          lib32gcc-s1 libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev \
          libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool \
          libz-dev lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full \
          patch pkgconf python3 python3-pyelftools python3-setuptools \
          qemu-utils rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs unzip upx-ucl vim wget xmlto xxd zlib1g-dev zstd
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone ImmortalWrt
      working-directory: /workdir
      run: |
        git clone --depth 1 --branch $REPO_BRANCH $REPO_URL immortalwrt
        ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt
        cd immortalwrt
        echo "✅ ImmortalWrt cloned @ $(git log --oneline -1)"

    # ★ 验证 HC5861B 是否存在
    - name: Verify HC5861B device support
      run: |
        cd immortalwrt
        echo "==========================================="
        echo "  Searching for HC5861B in ImmortalWrt"
        echo "==========================================="

        # 搜索所有可能的位置
        echo "--- Search in mt7620.mk ---"
        MT7620_MK="target/linux/ramips/image/mt7620.mk"
        if [ -f "$MT7620_MK" ]; then
          grep -i "hc5861" "$MT7620_MK" || echo "(not in mt7620.mk)"
        fi

        echo ""
        echo "--- Search in mt76x8.mk ---"
        MT76X8_MK="target/linux/ramips/image/mt76x8.mk"
        if [ -f "$MT76X8_MK" ]; then
          grep -i "hc5861" "$MT76X8_MK" || echo "(not in mt76x8.mk)"
        fi

        echo ""
        echo "--- Search all image mk files ---"
        grep -rl "hc5861" target/linux/ramips/image/ || echo "(not found in image/)"

        echo ""
        echo "--- Search DTS files ---"
        find target/linux/ramips/dts/ -iname "*hc5861*" -type f
        find target/linux/ramips/dts/ -iname "*r33*" -type f

        echo ""
        echo "--- Search globally ---"
        grep -rl "hc5861b\|HC5861B" target/ || echo "(hc5861b not found globally)"
        grep -rl "hiwifi.*r33\|R33" target/ || echo "(R33 not found globally)"

        echo ""
        echo "--- All HiWiFi devices ---"
        grep -i "hiwifi" target/linux/ramips/image/*.mk | grep "Device/" || true

        echo ""
        echo "==========================================="

        # 尝试找到设备定义
        DEVICE_FOUND=false

        # 检查各种可能的命名
        for name in hc5861b hc5861-b hc5861 r33; do
          if grep -rq "Device/hiwifi_${name}" target/linux/ramips/image/; then
            echo "✅ Found device: hiwifi_${name}"
            echo "DEVICE_ID=hiwifi_${name}" >> $GITHUB_ENV
            DEVICE_FOUND=true

            # 打印完整设备定义
            echo "--- Full device definition ---"
            FILE=$(grep -rl "Device/hiwifi_${name}" target/linux/ramips/image/)
            sed -n "/define Device\/hiwifi_${name}/,/^$/p" "$FILE"
            echo "------------------------------"
            break
          fi
        done

        if [ "$DEVICE_FOUND" = false ]; then
          echo ""
          echo "❌ HC5861B / R33 NOT FOUND in ImmortalWrt either!"
          echo ""
          echo "Available HiWiFi devices in ImmortalWrt:"
          grep "Device/hiwifi" target/linux/ramips/image/*.mk || true
          echo ""
          echo "This device may require manual DTS creation."
          echo "Please report this issue."
          exit 1
        fi

    - name: Add Passwall2 feeds
      run: |
        chmod +x scripts/feeds.sh
        cd immortalwrt
        $GITHUB_WORKSPACE/scripts/feeds.sh

    - name: Update and install feeds
      run: |
        cd immortalwrt

        for i in 1 2 3; do
          echo ">>> feeds update attempt $i/3"
          ./scripts/feeds update -a && break
          sleep 15
          [ $i -eq 3 ] && { echo "❌ feeds update failed"; exit 1; }
        done

        ./scripts/feeds install -a

        # 验证
        echo "=== Verify key packages ==="
        for pkg in luci-app-passwall2 hysteria sing-box chinadns-ng; do
          ./scripts/feeds list | grep -q "^$pkg " && echo "✅ $pkg" || echo "⚠️  $pkg"
        done

    - name: Generate configuration
      run: |
        chmod +x scripts/customize.sh
        cd immortalwrt
        cp $GITHUB_WORKSPACE/configs/hc5861b.config .config
        $GITHUB_WORKSPACE/scripts/customize.sh
        make defconfig

        echo "========== Config verify =========="
        echo "--- Target ---"
        grep "^CONFIG_TARGET" .config | head -5
        echo "--- Device ---"
        grep "DEVICE.*hiwifi\|DEVICE.*hc586" .config | grep "=y"
        echo "--- Passwall2 ---"
        grep -i "passwall2" .config | grep "=y"
        echo "--- Hysteria ---"
        grep -iE "hysteria|sing.box" .config | grep "=y"
        echo "--- TPROXY ---"
        grep -i "tproxy" .config | grep "=y"
        echo "--- zram ---"
        grep -i "zram" .config | grep "=y"
        echo "==================================="
        echo ""
        echo "========== diffconfig =========="
        ./scripts/diffconfig.sh
        echo "================================"

    - name: Download packages
      run: |
        cd immortalwrt
        make download -j16
        find dl -size -1024c -exec rm -f {} \;
        echo "✅ $(ls dl/ | wc -l) source archives"

    - name: Compile
      id: compile
      run: |
        cd immortalwrt
        echo "Started: $(date), Threads: $(nproc)"

        make -j$(nproc) 2>&1 | tee /tmp/build.log | grep -E "^\[|error" | tail -30
        BUILD_EXIT=${PIPESTATUS[0]}

        if [ $BUILD_EXIT -ne 0 ]; then
          echo "⚠️  Retrying single-thread..."
          make -j1 V=s 2>&1 | tee /tmp/build-v.log | tail -200
          BUILD_EXIT=$?
        fi

        [ $BUILD_EXIT -ne 0 ] && { echo "❌ BUILD FAILED"; exit 1; }

        echo "Finished: $(date)"
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Verify firmware
      if: steps.compile.outputs.status == 'success'
      run: |
        OUTPUT="immortalwrt/bin/targets/ramips/mt7620"

        [ ! -d "$OUTPUT" ] && { echo "❌ Output dir not found"; find immortalwrt/bin/targets/ -type d; exit 1; }

        echo "========== Output files =========="
        ls -lhS "$OUTPUT"/
        echo "=================================="

        # 搜索包含 hc5861 或 hiwifi 的固件
        SYSUPGRADE=$(find "$OUTPUT" -name 
