name: Build OpenWrt HC5861 Hysteria2

on:
  workflow_dispatch:
    inputs:
      RELEASE:
        description: '发布到 Release'
        type: boolean
        default: true

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: v23.05.5
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Install dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache clang cmake cpio curl \
          device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
          g++-multilib git gnutls-dev gperf haveged help2man intltool jq \
          lib32gcc-s1 libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev \
          libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool \
          libz-dev lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full \
          patch pkgconf python3 python3-pyelftools python3-setuptools \
          qemu-utils rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs unzip upx-ucl vim wget xmlto xxd zlib1g-dev zstd
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone OpenWrt ${{ env.REPO_BRANCH }}
      working-directory: /workdir
      run: |
        git clone --depth 1 --branch $REPO_BRANCH $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        echo "✅ OpenWrt $(cat version) @ $(git log --oneline -1)"

    - name: Verify device support
      run: |
        cd openwrt
        echo "==========================================="
        echo "  Checking HC5861 device support"
        echo "==========================================="

        MT7620_MK="target/linux/ramips/image/mt7620.mk"

        if [ ! -f "$MT7620_MK" ]; then
          echo "❌ $MT7620_MK not found"
          exit 1
        fi

        # ★ 修正：查找 hc5861（非 hc5861b）
        if grep -q "Device/hiwifi_hc5861" "$MT7620_MK"; then
          echo "✅ hiwifi_hc5861 FOUND"
          echo ""
          echo "--- Device definition ---"
          sed -n '/define Device\/hiwifi_hc5861$/,/^$/p' "$MT7620_MK"
          echo "-------------------------"
        else
          echo "❌ hiwifi_hc5861 NOT FOUND"
          exit 1
        fi

        # 检查 DTS
        echo "--- DTS files ---"
        find target/linux/ramips/dts/ -name "*hc5861*" -type f
        echo "-----------------"

    - name: Add Passwall2 feeds
      run: |
        chmod +x scripts/feeds.sh
        cd openwrt
        $GITHUB_WORKSPACE/scripts/feeds.sh

    - name: Update and install feeds
      run: |
        cd openwrt

        for i in 1 2 3; do
          echo ">>> feeds update attempt $i/3"
          ./scripts/feeds update -a && break
          echo "⚠️  Failed, waiting 15s..."
          sleep 15
          [ $i -eq 3 ] && { echo "❌ feeds update failed"; exit 1; }
        done

        ./scripts/feeds install -a

        # 验证
        echo "=== Verify feeds ==="
        for feed in passwall_packages passwall2; do
          test -d "feeds/$feed" && echo "✅ $feed" || { echo "❌ $feed MISSING"; exit 1; }
        done

        echo "=== Verify packages ==="
        for pkg in luci-app-passwall2 hysteria sing-box chinadns-ng; do
          ./scripts/feeds list | grep -q "^$pkg " && echo "✅ $pkg" || echo "⚠️  $pkg not found"
        done

    - name: Generate configuration
      run: |
        chmod +x scripts/customize.sh
        cd openwrt
        cp $GITHUB_WORKSPACE/configs/hc5861b.config .config
        $GITHUB_WORKSPACE/scripts/customize.sh
        make defconfig

        echo ""
        echo "========== Config check =========="
        echo "--- Target ---"
        grep "^CONFIG_TARGET" .config | head -5
        echo "--- Passwall2 ---"
        grep -i "passwall2" .config | grep "=y"
        echo "--- Proxy cores ---"
        grep -iE "hysteria|sing.box" .config | grep "=y"
        echo "--- TPROXY ---"
        grep -i "tproxy" .config | grep "=y"
        echo "--- zram ---"
        grep -i "zram" .config | grep "=y"
        echo "=================================="
        echo ""
        echo "========== diffconfig =========="
        ./scripts/diffconfig.sh
        echo "================================"

    - name: Download packages
      run: |
        cd openwrt
        make download -j16
        find dl -size -1024c -exec rm -f {} \;
        echo "✅ $(ls dl/ | wc -l) source archives"

    - name: Compile
      id: compile
      run: |
        cd openwrt
        echo "Started: $(date), Threads: $(nproc)"

        make -j$(nproc) 2>&1 | tee /tmp/build.log | grep -E "^\[|error" | tail -30
        BUILD_EXIT=${PIPESTATUS[0]}

        if [ $BUILD_EXIT -ne 0 ]; then
          echo "⚠️  Retrying single-thread..."
          make -j1 V=s 2>&1 | tee /tmp/build-v.log | tail -200
          BUILD_EXIT=$?
        fi

        [ $BUILD_EXIT -ne 0 ] && { echo "❌ BUILD FAILED"; exit 1; }

        echo "Finished: $(date)"
        echo "status=success" >> $GITHUB_OUTPUT

    # ★ 修正：查找 hc5861（非 hc5861b）
    - name: Verify firmware
      if: steps.compile.outputs.status == 'success'
      run: |
        OUTPUT="openwrt/bin/targets/ramips/mt7620"

        [ ! -d "$OUTPUT" ] && { echo "❌ Output dir not found"; exit 1; }

        echo "========== Output files =========="
        ls -lhS "$OUTPUT"/
        echo "=================================="

        # ★ 关键修正：搜索 hc5861（非 hc5861b）
        SYSUPGRADE=$(find "$OUTPUT" -name "*hc5861*sysupgrade*" -type f | head -1)
        if [ -n "$SYSUPGRADE" ]; then
          SIZE=$(ls -lh "$SYSUPGRADE" | awk '{print $5}')
          echo "✅ Sysupgrade: $(basename $SYSUPGRADE) ($SIZE)"
        else
          echo "❌ Sysupgrade NOT FOUND"
          echo "All firmware files:"
          find "$OUTPUT" -type f \( -name "*.bin" -o -name "*.img" \) | sort
          exit 1
        fi

    - name: Organize files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/ramips/mt7620
        rm -rf packages/
        rm -f *.buildinfo *.manifest sha256sums
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success'
      with:
        name: OpenWrt-HC5861-Hysteria2-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: steps.compile.outputs.status == 'success' && github.event.inputs.RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v23.05.5-${{ env.FILE_DATE }}
        body: |
          ## OpenWrt 23.05.5 — 极路由3 Pro (HC5861) + Passwall2 Hysteria2

          | 项目 | 值 |
          |---|---|
          | 设备 | HiWiFi R33 / HC5861 / 极路由3 Pro |
          | CPU | MT7620A 单核 580MHz |
          | 内存 | 128MB DDR2 / 128MB NAND |
          | 默认 IP | **192.168.10.1** |
          | 默认密码 | 无 |

          ### 包含组件
          - ✅ Passwall2 (中文界面)
          - ✅ Hysteria2 独立客户端
          - ✅ SingBox 备选核心 (含 QUIC)
          - ✅ ChinaDNS-NG DNS 分流
          - ✅ TPROXY TCP+UDP 透明代理
          - ✅ zram-swap 内存优化

          ### 使用
          1. Breed 刷入 `sysupgrade.bin`
          2. 访问 `192.168.10.1`
          3. 服务 → PassWall2 → 添加 Hysteria2 节点
          4. 开启主开关，所有设备自动走代理
        files: ${{ env.FIRMWARE }}/*
